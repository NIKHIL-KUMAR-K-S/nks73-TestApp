name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and publish to GHCR"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, linux, codespace, runner-1]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract image values from workflow_run
        id: vars
        run: |
          echo "IMAGE_REPO=${{ github.event.workflow_run.outputs.IMAGE_REPO }}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${{ github.event.workflow_run.outputs.IMAGE_TAG }}" >> $GITHUB_OUTPUT

      - name: Ensure kubectl is available
        run: |
          kubectl version --client || { echo "kubectl missing"; exit 1; }

      - name: Ensure helm is available
        run: |
          helm version || { echo "helm missing"; exit 1; }

      - name: Write kubeconfig file
        run: |
          echo "${{ secrets.KUBECONFIG_DEV }}" > kubeconfig
          chmod 600 kubeconfig

      - name: Deploy using Helm
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          echo "Deploying image ${{ steps.vars.outputs.IMAGE_REPO }}:${{ steps.vars.outputs.IMAGE_TAG }}"
          helm upgrade --install devops-starter ./helm-chart \
            -n dev --create-namespace \
            --set image.repository=${{ steps.vars.outputs.IMAGE_REPO }} \
            --set image.tag=${{ steps.vars.outputs.IMAGE_TAG }}

      - name: Verify rollout
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          kubectl rollout status deployment/devops-starter-devops-starter -n dev --timeout=120s
